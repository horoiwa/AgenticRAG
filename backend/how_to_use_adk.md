# Google Agent Development Kit (ADK) の使い方

## 概要

Google Agent Development Kit (ADK) は、AIエージェントの開発とデプロイを支援するためにGoogleが提供する、柔軟でモジュール式のオープンソースフレームワークです。GeminiやGoogleエコシステムに最適化されていますが、モデルやデプロイメントに依存せず、他のフレームワークとの互換性も考慮されています。

## Google ADKの主な機能と特徴

*   **柔軟なオーケストレーション**：予測可能なパイプラインのためのワークフローエージェント（シーケンシャル、パラレル、ループ）や、適応的な動作のためのLLM駆動型動的ルーティング（LlmAgent転送）を使用してワークフローを定義できます。
*   **マルチエージェントアーキテクチャ**：複数の専門エージェントを階層的に構成することで、モジュール式でスケーラブルなアプリケーションを構築できます。
*   **豊富なツールエコシステム**：事前構築されたツール（Search、Code Exec）の使用、カスタム関数の作成、サードパーティライブラリの統合、さらには他のエージェントをツールとして使用するなど、多様な機能をエージェントに装備できます。
*   **モデル非依存**：Geminiだけでなく、GPT-4o、Claude、Mistralなど、さまざまなAIモデルと連携できます。
*   **デプロイメント対応**：エージェントをコンテナ化し、ローカルでの実行、Vertex AI Agent Engineでのスケーリング、Cloud RunやDockerを使用したカスタムインフラストラクチャへの統合など、どこにでもデプロイできます。
*   **組み込みの評価機能**：定義済みのテストケースに対して、最終的な応答品質と段階的な実行軌跡の両方を評価することで、エージェントのパフォーマンスを体系的に評価できます。
*   **セッションとメモリ**：エージェントの状態、知識、成果物をセッション間で保存するメカニズムを提供し、長期的なコンテキストを維持します。
*   **A2Aプロトコル**：異なるプラットフォームやフレームワーク間でAIエージェントが簡単に通信・連携できるようにする、オープンでベンダーニュートラルな標準プロトコルをサポートしています。

## Google ADKの始め方

1.  **インストール**：Pythonの場合、`pip install google-adk` コマンドでインストールできます。Javaの場合もMavenやGradleで依存関係を追加します。
2.  **クイックスタートガイド**：ADKのインストール、複数のツールを備えた基本的なエージェントのセットアップ、およびターミナルまたはブラウザベースの開発UIでのローカル実行について説明するクイックスタートガイドが提供されています。
3.  **開発環境**：Python 3.9以上またはJava 17以上、およびターミナルアクセスを備えたローカルIDE（VS Code、PyCharmなど）が必要です。

## エージェントとの対話方法

ADKで構築されたエージェントとは、以下の方法で対話できます。

*   **Dev UI (`adk web`)**：インタラクティブなブラウザベースのUIで、エージェントとのチャットやイベントの検査、トレースログの確認が可能です。
*   **ターミナル (`adk run`)**：コマンドラインからエージェントと対話できます。
*   **APIサーバー (`adk api_server`)**：ローカルのFastAPIサーバーを起動し、cURLリクエストなどでエージェントをテストできます。

## なぜADKを使用するのか

ADKは、モジュール性、再利用性、保守性といった従来のソフトウェアエンジニアリングの原則と、エージェントAIアーキテクチャの新たなニーズを融合させることで、洗練された自律型エージェントシステムの構築における課題に対処します。複雑なマルチエージェントシステムを構築および評価する際に、より多くの自由度とサポートを提供します。

## サンプルコード

以下に、Google ADK を使用した簡単なエージェントの例を示します。このエージェントは、指定された都市の現在時刻を返すツールを使用します。

### 1. インストール
まず、pip を使用して ADK パッケージをインストールします。

```bash
pip install google-adk
```

インストールする前に Python 仮想環境を作成してアクティブ化することを推奨します。

### 2. エージェントプロジェクトの作成

`adk create` コマンドを使用して、新しいエージェントプロジェクトを構築します。

```bash
adk create my_agent
```

このコマンドは、`my_agent` ディレクトリを作成し、通常 `agent.py`、`__init__.py`、および `.env` ファイルが含まれます。

### 3. ツールを使用したシンプルなエージェントの定義 (`my_agent/agent.py`)

`agent.py` ファイルには、エージェントの主要な制御コードが含まれます。`root_agent` を定義し、それを使用できるツール（Python 関数）を装備できます。

以下は、指定された都市の現在時刻を伝えるエージェントの例です。

```python
from google.adk.agents.llm_agent import Agent

# モックツールの実装
def get_current_time(city: str) -> dict:
    """指定された都市の現在時刻を返します。"""
    # 実際のシナリオでは、これは外部APIまたはサービスを呼び出します
    import datetime
    import pytz

    try:
        # 指定された都市のタイムゾーンを取得します (例のために簡略化されています)
        # より堅牢なソリューションには、タイムゾーンAPIまたは包括的なマッピングが含まれます。
        if city.lower() == "london":
            tz = pytz.timezone("Europe/London")
        elif city.lower() == "new york":
            tz = pytz.timezone("America/New_York")
        elif city.lower() == "tokyo":
            tz = pytz.timezone("Asia/Tokyo")
        else:
            return {"status": "error", "message": f"{city} の時刻は利用できません。"}

        current_time = datetime.datetime.now(tz).strftime("%H:%M %p")
        return {"status": "success", "city": city, "time": current_time}
    except Exception as e:
        return {"status": "error", "message": str(e)}

root_agent = Agent(
    model='gemini-2.5-flash',  # 使用するLLMモデルを指定します
    name='root_agent',
    description="指定された都市の現在時刻を伝えます。",
    instruction="あなたは都市の現在時刻を伝えるのに役立つアシスタントです。この目的のために 'get_current_time' ツールを使用してください。",
    tools=[get_current_time],
)
```

この例では、`get_current_time` 関数をツールとして定義しています。`root_agent` は、都市の時刻について尋ねられたときにこのツールを使用するように指示されています。

### 4. APIキーの設定 (`my_agent/.env`)

指定されたモデルを使用するには、Gemini API キーが必要です。`my_agent` ディレクトリ内の `.env` ファイルを API キーで作成または更新します。

```
GOOGLE_API_KEY="YOUR_API_KEY"
```

API キーは Google AI Studio で生成できます。

### 5. エージェントの実行

エージェントはコマンドラインまたはウェブインターフェースで実行できます。

*   **コマンドラインインターフェース:**
    `my_agent` の親ディレクトリに移動し、以下を実行します。

    ```bash
    adk run my_agent
    ```

    その後、ターミナルでプロンプトを入力してエージェントと対話できます。

*   **Webインターフェース:**
    ウェブインターフェースで実行するには、`my_agent` の親ディレクトリに移動し、以下を実行します。

    ```bash
    adk web --port 8000
    ```

    これによりウェブサーバーが起動し、`http://localhost:8000` でチャットインターフェースにアクセスできます。エージェントを選択し、リクエストを入力します。

## RAG (Retrieval-Augmented Generation) の例 (Google ADK の場合)

RAG (Retrieval-Augmented Generation) は、大規模言語モデル (LLM) が外部の知識ベースから情報を取得し、それに基づいて応答を生成する技術です。これにより、LLM の応答の正確性、関連性、および最新性が向上します。

Google ADK で RAG エージェントを実装する場合、RAG の各ステップ (情報検索、情報生成) をカスタムツールとして定義し、エージェントにそれらのツールを適切に利用させるように指示します。

以下に、Google ADK を使用した RAG エージェントの概念的な実装例を示します。この例では、簡略化のために情報検索ツールがハードコードされた情報を返しますが、実際のアプリケーションでは、このツールはベクトルデータベースや検索エンジンと連携します。

### 1. RAG 検索ツールの定義

まず、情報を検索するためのカスタムツールを定義します。このツールは、ユーザーのクエリに基づいて関連するドキュメントや情報を「検索」する役割を担います。

```python
# my_agent/agent.py 内、または別のツールファイル (例: my_agent/tools.py) に記述

def retrieve_information(query: str) -> str:
    """
    ユーザーのクエリに基づいて関連情報を検索します。
    実際のアプリケーションでは、この関数はベクトルデータベース、検索エンジン、
    またはその他の知識ベースから情報を取得します。
    """
    # ここでは簡略化のため、ハードコードされた情報を返します。
    # 実際の RAG では、クエリに基づいて関連性の高いチャンクが取得されます。
    if "LangChain" in query:
        return "LangChain は、大規模言語モデル (LLM) を使用したアプリケーションの作成を簡素化するために設計されたフレームワークです。LLM を外部データソースやエージェントと接続するためのツールと抽象化を提供します。"
    elif "RAG" in query:
        return "RAG (Retrieval-Augmented Generation) は、LLM が外部知識ベースから情報を取得し、それに基づいて応答を生成する技術です。これにより、LLM の応答の正確性、関連性、および最新性が向上します。"
    else:
        return "関連情報は見つかりませんでした。"

```

### 2. RAG エージェントの定義

次に、この検索ツールを利用する ADK エージェントを定義します。エージェントの `instruction` は、質問に答える前に `retrieve_information` ツールを使用して関連情報を取得するように指示します。

```python
# my_agent/agent.py

from google.adk.agents.llm_agent import Agent
# retrieve_information 関数が別のファイルにある場合は、ここでインポートします
# from .tools import retrieve_information 

# RAG 検索ツールを定義 (上記で定義した関数)
# def retrieve_information(query: str) -> str:
#     ... (上記コードをここにコピーするか、インポートします) ...

root_agent = Agent(
    model='gemini-2.5-flash',  # 使用するLLMモデルを指定します
    name='rag_agent',
    description="RAG を使用して質問に回答するエージェントです。",
    instruction="""
あなたは質問応答タスクのアシスタントです。
質問に答える前に、必ず `retrieve_information` ツールを使用して関連情報を検索してください。
検索結果を考慮して、簡潔かつ正確に回答を生成してください。
もし `retrieve_information` ツールが関連情報を見つけられなかった場合は、その旨を伝えてください。
""",
    tools=[retrieve_information], # 定義した検索ツールをエージェントに渡します
)
```

### 3. APIキーの設定 (`my_agent/.env`)

指定されたモデルを使用するには、Gemini API キーが必要です。`my_agent` ディレクトリ内の `.env` ファイルを API キーで作成または更新します。

```
GOOGLE_API_KEY="YOUR_API_KEY"
```

API キーは Google AI Studio で生成できます。

### 4. エージェントの実行

エージェントはコマンドラインまたはウェブインターフェースで実行できます。

*   **コマンドラインインターフェース:**
    `my_agent` の親ディレクトリに移動し、以下を実行します。

    ```bash
    adk run my_agent
    ```

    その後、ターミナルでプロンプトを入力してエージェントと対話できます。

*   **Webインターフェース:**
    ウェブインターフェースで実行するには、`my_agent` の親ディレクトリに移動し、以下を実行します。

    ```bash
    adk web --port 8000
    ```

    これによりウェブサーバーが起動し、`http://localhost:8000` でチャットインターフェースにアクセスできます。エージェントを選択し、リクエストを入力します。

### 動作の仕組み

この RAG エージェントは、ユーザーからの質問を受け取ると、まず `retrieve_information` ツールを呼び出します。このツールは、質問に関連する情報を知識ベースから取得します。取得された情報は、LLM への入力プロンプトの一部として渡され、LLM はその情報に基づいて質問に回答を生成します。これにより、LLM は外部の最新情報や特定のドキュメントの内容を参照しながら、より正確で根拠のある応答を提供できるようになります。

このように、ADK の柔軟なツールエコシステムを活用することで、RAG のような高度な機能をエージェントに簡単に統合し、より強力でインテリジェントなアプリケーションを構築できます。
